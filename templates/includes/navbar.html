{% load static %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<link rel="stylesheet" type="text/css" href="{% static 'css/navbar.css' %}">

<div class="top-navbar">
  <div class="hamburger" id="hamburger">
    <i class="fas fa-bars"></i>
  </div>

  <div class="logo">BRITS Helpdesk</div>

  <div class="nav-items" id="navItems">
    <div class="notifications" id="notificationBell">
      <i class="fas fa-bell"></i>
      <span class="badge" id="notificationCount" style="display: none;">0</span>

      <div class="dropdown-menu notifications-dropdown" id="notificationsDropdown">
        <div id="notificationsList">
          <p class="empty">No tickets</p>
        </div>
        <div class="view-all">
          <a href="{% url 'escalated_tickets_list' %}">View all</a>
        </div>
      </div>
    </div>

    <div class="user-profile" id="userProfile">
      <div class="profile-trigger">
        <img src="{% if user.profile.avatar %}{{ user.profile.avatar.url }}{% else %}https://placehold.co/40x40{% endif %}" alt="User Avatar">
        <span>{{ user.get_full_name|default:user.username }}</span>
        <i class="fas fa-chevron-down"></i>
      </div>
      <div class="dropdown-menu">
        <a href="{% url 'profile_view' %}">üë§ Profile</a>
        <a href="{% url 'settings' %}">‚öôÔ∏è Settings</a>
        <form id="logout-form" method="post" action="{% url 'logout' %}" style="margin: 0;">
          {% csrf_token %}
          <button type="submit" class="dropdown-link logout-btn">üö™ Logout</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
const profileViewUrl = "{% url 'profile_view' %}";

function getCSRFToken() {
  const name = "csrftoken";
  const cookies = document.cookie.split("; ");
  for (let c of cookies) {
    if (c.startsWith(name + "=")) {
      return decodeURIComponent(c.split("=")[1]);
    }
  }
  return "";
}

const fetchEscalationsUrl = "{% url 'get_notifications' %}";

let escalationSocket;

// ==== Initialize WebSocket ====
(function () {
  const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
  const url = `${wsScheme}://${window.location.host}/ws/escalations/`;
  console.log("Connecting to WebSocket at:", url);

  escalationSocket = new WebSocket(url);

  escalationSocket.onopen = () => {
    console.log("‚úÖ Connected to escalation WebSocket");
  };

  escalationSocket.onclose = () => {
    console.error("‚ùå WebSocket closed unexpectedly");
  };

  escalationSocket.onmessage = (e) => {
    const data = JSON.parse(e.data);
    console.log("üì© WebSocket message received:", data);

    switch (data.type) {
      case "notifications_list":
        if (data.tickets) renderNotifications(data.tickets, data.count);
        break;

      case "ticket_creation":
        console.log("‚û°Ô∏è Ticket creation payload:", data);
        if (data.ticket) handleNewTicket(data.ticket);
        break;

      case "escalation_message":
        if (data.message) showNotification(data.message);
        break;

      case "unassigned_ticket_notification":
        if (data.ticket) handleNewUnassignedTicket(data.ticket);
        break;

      default:
        console.warn("‚ö†Ô∏è Unknown WebSocket event type:", data.type);
    }
  };
})();

// ==== Initial Fetch ====
fetch(fetchEscalationsUrl)
  .then((r) => {
    if (!r.ok) throw new Error("HTTP " + r.status);
    const ct = r.headers.get("content-type") || "";
    if (!ct.includes("application/json")) {
      return r.text().then((txt) => {
        throw new Error("Expected JSON, got: " + txt.slice(0, 100));
      });
    }
    return r.json();
  })
  .then((data) => renderNotifications(data.tickets || [], data.count))
  .catch((err) => console.error("Error fetching tickets:", err));



// ==== Render Single Notification ====
function createNotificationItem(ticket) {
  const div = document.createElement("div");
  div.classList.add("notification-item");

  let typeLabel;
  if (ticket.notification_type === "unassigned") {
    typeLabel = `<span class="badge badge-unassigned">Unassigned</span>`;
  } else if (ticket.notification_type === "escalated" || ticket.is_escalated) {
    typeLabel = `<span class="badge badge-escalated">Escalated</span>`;
  } else {
    typeLabel = `<span class="badge badge-new">New</span>`;
  }

  const priorityText = ticket.priority || "N/A";

  div.innerHTML = `
    <a class="dropdown-item notification-link" 
       href="/tickets/${ticket.id}/" 
       data-ticket-id="${ticket.id}" 
       data-type="${ticket.notification_type}">
      ${typeLabel} #${ticket.id} - ${ticket.title}<br>
      <small>${priorityText} | ${ticket.escalated_at || ticket.created_at}</small>
    </a>
  `;

  return div;
}


document.addEventListener("click", function (e) {
  const link = e.target.closest(".notification-link");
  if (!link) return;

  e.preventDefault();

  const ticketId = link.getAttribute("data-ticket-id");
  const type = link.getAttribute("data-type");
  const targetUrl = link.getAttribute("href");

  fetch(`/notifications/mark_read/${ticketId}/`, {
    method: "POST",
    headers: {
      "X-CSRFToken": getCSRFToken(),
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ type })
  })
  .then(r => r.json())  // Ensure you parse the response to check the success
  .then(response => {
    if (response.success) {
      const wrapper = link.closest(".notification-item");
      if (wrapper) wrapper.remove();

      // Update badge count
      const countEl = document.getElementById("notificationCount");
      const current = parseInt(countEl.textContent || "0", 10);
      countEl.textContent = current > 1 ? current - 1 : 0;
      countEl.style.display = current > 1 ? "inline-block" : "none";

      // Redirect to ticket page
      window.location.href = targetUrl;
    } else {
      console.error("Failed to mark as read:", response.info);
      window.location.href = targetUrl;
    }
  })
  .catch(err => {
    console.error(err);
    window.location.href = targetUrl;
  });
});







// ==== Render Escalations ====
function renderNotifications(tickets, totalCount) {
  const countEl = document.getElementById("notificationCount");
  const listEl = document.getElementById("notificationsList");
  const viewAllEl = document.querySelector(".view-all");
  if (!countEl || !listEl) return;

  listEl.innerHTML = "";

  if (!tickets || tickets.length === 0) {
    listEl.innerHTML = `<div class="dropdown-item text-muted empty">No tickets</div>`;
    countEl.style.display = "none";
    return;
  }

  tickets.slice(0, 5).forEach((t) => listEl.appendChild(createNotificationItem(t)));

  countEl.textContent = (typeof totalCount === "number") ? totalCount : tickets.length;
  countEl.style.display = "inline-block";
  if (viewAllEl) viewAllEl.style.display = "block";
}



// Handle new ticket event
function handleNewTicket(ticket) {
  const countEl = document.getElementById("notificationCount");
  const listEl = document.getElementById("notificationsList");

  if (!countEl || !listEl) return;

  const emptyMsg = document.querySelector(".empty");
  if (emptyMsg) emptyMsg.remove();

  // Ensure ticket has a notification_type
  if (!ticket.notification_type) {
    ticket.notification_type = (ticket.is_escalated || ticket.escalated_at) ? "escalated" : "new";
  }

  console.log("New ticket type:", ticket.notification_type);

  listEl.prepend(createNotificationItem(ticket));

  const items = listEl.querySelectorAll(".notification-item");
  if (items.length > 5) listEl.removeChild(items[items.length - 1]);

  const current = parseInt(countEl.textContent || "0", 10);
  countEl.textContent = isNaN(current) ? 1 : (current + 1);
  countEl.style.display = "inline-block";
}


function handleNewUnassignedTicket(ticket) {
  const countEl = document.getElementById("notificationCount");
  const listEl = document.getElementById("notificationsList");

  if (!countEl || !listEl) return;

  const emptyMsg = document.querySelector(".empty");
  if (emptyMsg) emptyMsg.remove();

  console.log("Unassigned ticket received:", ticket);

  ticket.notification_type = "unassigned"; // Set notification type to unassigned
  listEl.prepend(createNotificationItem(ticket));

  const items = listEl.querySelectorAll(".notification-item");
  if (items.length > 5) listEl.removeChild(items[items.length - 1]);

  const current = parseInt(countEl.textContent || "0", 10);
  countEl.textContent = isNaN(current) ? 1 : (current + 1);
  countEl.style.display = "inline-block";
}





// ==== Show Text Notification ====
function showNotification(message) {
  const listEl = document.getElementById("notificationsList");
  if (!listEl) return;

  const text = (typeof message === "string") ? message : JSON.stringify(message);

  const div = document.createElement("div");
  div.classList.add("notification-item", "new-message");
  div.innerHTML = `<div class="dropdown-item">üîî ${text}</div>`;
  listEl.prepend(div);

  setTimeout(() => { div.remove(); }, 10000);
}



// ==== Dropdown Toggle ====
const bell = document.getElementById("notificationBell");
const menu = document.getElementById("notificationsDropdown");
if (bell && menu) {
  bell.addEventListener("click", () => menu.classList.toggle("show"));
}
</script>
<script src="{% static 'js/files_navbar.js' %}"></script>
